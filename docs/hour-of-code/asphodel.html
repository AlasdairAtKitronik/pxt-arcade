<!DOCTYPE html>
<html
    lang="en-US"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="http://www.facebook.com/2008/fbml"
>
    <head>
        <meta charset="UTF-8" />
        <title>Microsoft MakeCode Arcade Hour of Code 2020</title>
        <meta
            name="Description"
            content="Microsoft MakeCode Arcade Hour of Code 2020"
        />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=yes"
        />

        <!-- @include scripthead.html -->
        <link rel="stylesheet" href="/static/hour-of-code/styles.css" />
        <style>
            body {
                background-image: url('/static/hour-of-code/pixel-background-secondary.png');
            }

            #main .action-button {
                border-image-source: url('/static/hour-of-code/shadowed-button-frame.png');
            }

            #main .panel-primary {
                border-image-source: url('/static/hour-of-code/shadowed-primary-frame.png');
            }

            #main .panel-secondary {
                border-image-source: url('/static/hour-of-code/shadowed-aside-frame.png');
            }

            #main header {
                background-image: url('/static/hour-of-code/pixel-background-primary.png');
            }
            #main {
                height: 95vh;
            }

            iframe {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: calc(100% - 6em);
                border: none;
                margin-top: 3em;
            }
        </style>

        <script>
            function handleOnLoad() {
                document
                    .querySelector('#openhome')
                    .addEventListener('click', function () {
                        window.pxtTickEvent('hourofcode2020.home', { src: "asphodel" });
                    });

                var langPicker = document.querySelector('#langpicker');
                if (langPicker) {
                    langPicker.remove();
                }

                // prebuilt js; only change is adding
                // helpers._postToParent({ level: currentLevel, duration: control.millis() });
                // at the start of startLevel: https://makecode.com/_2Hq7upduTFzW
                makeCodeRun({
                    js: "/static/hour-of-code/asphodel.js"
                });
            }

            function makeCodeRun(options) {
                var code = "";
                var isReady = false;
                var simState = {}
                var simStateChanged = false
                var started = false;
                var meta = undefined;

                // hide scrollbar
                window.scrollTo(0, 1);
                // init runtime
                initSimState();
                fetchCode();

                // helpers
                function fetchCode() {
                    sendReq(options.js, function (c, status) {
                        if (status != 200)
                            return;
                        code = c;
                        // load simulator with correct version
                        document.getElementById("simframe")
                            .setAttribute("src", "/sim/simulator.html");
                            // .setAttribute("src", meta.simUrl);
                    })
                }

                function startSim() {
                    if (!code || !isReady || started)
                        return
                    setState("run");
                    started = true;
                    const runMsg = {
                        type: "run",
                        parts: [],
                        code: code,
                        partDefinitions: {},
                        cdnUrl: "@cdnUrl@",
                        version: "@version@",
                        storedState: simState,
                        frameCounter: 1,
                        id: "green-" + Math.random()
                    }
                    postMessage(runMsg);
                }

                function stopSim() {
                    setState("stopped");
                    postMessage({ type: "stop" });
                    started = false;
                }

                window.addEventListener('message', function (ev) {
                    var d = ev.data
                    if (d.type == "sim-post-message" && d.data) {
                        var level = d.data.level;
                        var duration = d.data.duration;
                        window.pxtTickEvent(
                            'hourofcode2020.asphodel',
                            {
                                level: level,
                                duration: duration
                            }
                        );
                    } else if (d.type == "ready") {
                        isReady = true;
                        startSim();
                    } else if (d.type == "simulator") {
                        switch (d.command) {
                            case "restart":
                                stopSim();
                                startSim();
                                break;
                            case "setstate":
                                if (d.stateValue === null)
                                    delete simState[d.stateKey];
                                else
                                    simState[d.stateKey] = d.stateValue;
                                simStateChanged = true;
                                break;
                        }
                    }
                }, false);

                // helpers
                function setState(st) {
                    var r = document.getElementById("root");
                    if (r)
                        r.setAttribute("data-state", st);
                }

                function postMessage(msg) {
                    const frame = document.getElementById("simframe");
                    if (frame)
                        frame.contentWindow.postMessage(msg, "http://localhost:3232/sim/simulator.html");
                        // frame.contentWindow.postMessage(msg, meta.simUrl);
                }

                function sendReq(url, cb) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (xhttp.readyState == 4) {
                            cb(xhttp.responseText, xhttp.status)
                        }
                    };
                    xhttp.open("GET", url, true);
                    xhttp.send();
                }

                function initSimState() {
                    try {
                        simState = JSON.parse(localStorage["simstate"])
                    } catch (e) {
                        simState = {}
                    }
                    setInterval(function () {
                        if (simStateChanged)
                            localStorage["simstate"] = JSON.stringify(simState)
                        simStateChanged = false
                    }, 200)
                }
            }
        </script>
    </head>

    <body id="root" class="root background-color-secondary" onload="handleOnLoad()">
        <div id="main" role="presentation">
            <nav>
                <div class="arcade-logo">
                    <a href="/" id="openhome">
                        <img src="/static/logo.svg" alt="MakeCode Arcade" />
                    </a>
                </div>

                <div class="microsoft-logo">
                    <a
                        href="https://www.microsoft.com/en-us/makecode"
                        target="_blank"
                    >
                        <img src="/static/Micorsoft_logo_rgb_W-white_D.png" alt="Microsoft" />
                    </a>
                </div>
            </nav>

            <iframe id="simframe" allowfullscreen="allowfullscreen"
                sandbox="allow-popups allow-forms allow-scripts allow-same-origin">
            </iframe>
        </div>
        <!-- @include footer.html -->
        <!-- @include tracking.html -->
        <!-- @include tickevent.html -->
    </body>
</html>